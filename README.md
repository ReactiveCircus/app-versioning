# App Versioning

![CI](https://github.com/ReactiveCircus/app-versioning/workflows/CI/badge.svg)
[![Maven Central](https://maven-badges.herokuapp.com/maven-central/io.github.reactivecircus.appversioning/app-versioning-gradle-plugin/badge.svg)](https://search.maven.org/search?q=g:io.github.reactivecircus.appversioning)
[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)

A Gradle Plugin for lazily generating Android app's `versionCode` & `versionName` from Git tags.

**Minimum version of Android Gradle Plugin required is `4.0.0`.**

More details coming :soon:

## Installation

The **Android App Versioning Gradle Plugin** is available from both **Maven Central** and **Gradle Plugin Portal**. Make sure your top-level `build.gradle` has either `mavenCentral()` or `gradlePluginPortal()` defined in the `buildscript` block:

```groovy
buildscript {
    repositories {
        mavenCentral()
        gradlePluginPortal()
    }
}
```

The plugin can now be applied to your **Android Application** module (Gradle subproject).

If you use Kotlin DSL (`build.gradle.kts`):

```kotlin
plugins {
    id("com.android.application")
    id("io.github.reactivecircus.app-versioning") version "x.y.z"
}
```

If you use Groovy DSL (`build.gradle`):

```groovy
plugins {
    id 'com.android.application'
    id 'io.github.reactivecircus.app-versioning' version "x.y.z"
}
```

The `version` can be omitted by adding a classpath dependency in the `buildscript` block within the top-level `build.gradle`:

```groovy
buildscript {
    repositories {
        mavenCentral()
        google()
        gradlePluginPortal()
    }

    dependencies {
        classpath "io.github.reactivecircus.appversioning:app-versioning-gradle-plugin:x.y.z"
    }
}
```

## Usage

More details coming :soon:

### Gradle tasks

Plugin currently offers 2 Gradle tasks:

- `generateAppVersionInfoFor<BuildVariant>` - generates the `versionCode` and `versionName` for the `BuildVariant`. This task will be automatically run when building the APK or AAB e.g. by running `assemble<BuildVariant>` or `bundle<BuildVariant>`, and the generated `versionCode` and `versionName` will be injected into the final merged `AndroidManifest`.
- `printAppVersionInfoFor<BuildVariant>` - prints the latest `versionCode` and `versionName` generated by the plugin to the console if available.

## Configurations

The following work in both Groovy and Kotlin DSL (some of them might change):

```kotlin
appVersioning {
    /**
     * Whether to enable the plugin.
     *
     * Default is `true`.
     */
    enabled.set(true)

    /**
     * Whether to only generate version name and version code for `release` builds.
     *
     * Default is `false`.
     */
    releaseBuildOnly.set(false)

    /**
     * Whether to fetch git tags from remote when no valid git tag can be found locally.
     *
     * Default is `false`.
     */
    fetchTagsWhenNoneExistsLocally.set(false)

    /**
     * Provides a custom rule for generating versionCode by implementing a [GitTag], [ProviderFactory] -> Int lambda.
     * [GitTag] is generated from latest git tag lazily by the plugin during task execution.
     * [ProviderFactory] can be used for fetching environment variables, Gradle and system properties.
     *
     * By default the plugin attempts to generate the versionCode by converting a SemVer compliant tag to an integer
     * using positional notation: versionCode = MAJOR * 10000 + MINOR * 100 + PATCH
     *
     * If your tags don't follow semantic versioning, you don't like the default formula used to convert a SemVer tag to versionCode,
     * or if you want to fully customize how the versionCode is generated, you can implement this lambda to provide your own versionCode generation rule.
     *
     * Note that you can use the `gitTag.toSemVer()` extension (or `SemVer.fromGitTag(gitTag)` if you use groovy) to get a type-safe `SemVer` model
     * if your custom rule is still based on semantic versioning.
     */
    overrideVersionCode { _, _ ->
        // use timestamp as versionCode
        Instant.now().epochSecond.toInt()
    }

    /**
     * Provides a custom rule for generating versionName by implementing a [GitTag], [ProviderFactory] -> String lambda.
     * [GitTag] is generated from latest git tag lazily by the plugin during task execution.
     * [ProviderFactory] can be used for fetching environment variables, Gradle and system properties.
     *
     * This is useful if you want to fully customize how the versionName is generated.
     * If not specified, versionName will be the name of the latest git tag.
     */
    overrideVersionName { gitTag, providers ->
        // a custom versionName combining the tag name, commitHash and an environment variable
        val buildNumber = providers
            .environmentVariable("BUILD_NUMBER")
            .getOrElse("0").toInt()
        "${gitTag.rawTagName} - #$buildNumber (${gitTag.commitHash})"
    }
}
```

More samples will be added soon.

## License

```
Copyright 2020 Yang Chen

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
```
